{% extends "crud/detail.html" %}
{% load i18n %}
{% load common_tags %}
{% block actions %} {% endblock %}

{% block detail_content %}
	{% if sessoes|length == 0 %}
		<div class="alert alert-danger alert-dismissible" role="alert">
			<b>{{legislatura_selecionada}}</b> não possui nenhuma Sessão Legislativa cadastrada.<br />
			Clique <a href="{% url 'sapl.parlamentares:sessaolegislativa_create' %}">aqui</a> para cadastrar uma nova.
		</div>

	{% else %}
		<div class="alert alert-danger alert-dismissible" id="div-error" role="alert" style="display: none">
			<button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
      </button>
			<b><span id="error-message"></span></b>
		</div>

		<div class="alert alert-success alert-dismissible" id="div-success" style="display: none" role="alert">
     <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
     </button>
     <b><span id="success-message"></span></b>
    </div>

		<fieldset class="form-group">
			<legend>Escolha da Legislatura e da Sessão Legislativa</legend>
	    <div class="row">
	      <div class="col-md-6">
	        <label>Escolha uma Legislatura</label>
	        <select name="legislatura" id="id_legislatura" class="form-control">
	          {% for l in legislaturas %}
	          	<option value="{{l.id}}" {% if l == legislatura_selecionada %} selected {% endif %}>
	          		{{l}}
	          	</option>
	          {% endfor %}
	        </select>
	      </div>
	      <div class="col-md-6">
	        <label>Escolha uma Sessão Legislativa</label>
	        <select name="sessao" id="id_sessao_legislativa" class="form-control">
	          {% for s in sessoes %}
	          	<option value="{{s.id}}" {% if s == sessao_selecionada %} selected {% endif %}>
	          		{{s}}
	          	</option>
	          {% endfor %}
	        </select>
	      </div>
	    </div>
		</fieldset>
		<br />
		<fieldset class="form-group">
			
			<div class="context-actions clearfix">
  			<div class="actions btn-group float-right" style="margin:10px" role="group">
	  			<button type="button" class="btn btn-outline-primary btn-lg" data-toggle="modal" data-target="#addModal">Adicionar Novo Membro</button>
  			</div>
  		</div>


  			
			<legend>Escolha da Composição da Mesa Diretora</legend>
			<table class="table" id="id_composicao_mesa">
  			<thead>
  			  <tr>
  			    <th scope="col">Parlamentar</th>
  			    <th scope="col">Cargo</th>
  			    <th scope="col">Data de Inicio</th>
  			    <th scope="col">Data Fim</th>
						<th scope="col">Apagar</th>
  			  </tr>
  			</thead>
  			<tbody>
					{% for p in composicao_mesa %}
					<tr>
  			    <td>{{p.parlamentar}}</td>
  			    <td>{{p.cargo}}</td>
  			    <td>{{p.data_inicio|date:"d/m/Y"}}</td>
  			    <td>{{p.data_fim|date:"d/m/Y"}}</td>
  			    <td><button id="{{p.id}}" onclick="apaga_membro_mesa(this)" type="button" class="btn btn-danger">Apagar</button></td>

  			  </tr>
					{% endfor %}
  			</tbody>
			</table>
			</div>

		</fieldset>
		<!-- Modal -->
		<div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
		  <div class="modal-dialog" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title" id="addModalLabel">Novo Membro Da Mesa</h5>
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          <span aria-hidden="true">&times;</span>
		        </button>
		      </div>
		      <div class="modal-body">
		        
						<div id='parlamentar-cargo-title'>
		  				<div>
	        			<p>Parlamentar</p>
	        			<select class="form-control" name="parlamentar" id="id_parlamentar" style="display: none">
	        			  {% for p in parlamentares %}
	        			  	<option value="{{p.id}}">{{p.nome_parlamentar}}</option>
	        			  {% endfor %}
	        			</select>
							</div>
							<div>
								<p>Cargo</p>
	        			<select class="form-control" name="cargo" id="id_cargo" style="display: none">
	        			  {% for c in cargos_vagos %}
	        			  	<option value="{{c.id}}">{{c}}</option>
	        			  {% endfor %}
	        			</select>
							</div>
							<div class="row">
    						<div class="col-sm-6">
									<p>Data Inicio</p>
									<input class="form-control" type="text" id="datepicker">
								</div>

								<div class="col-sm-6">
									<p>Data Fim</p>
									<input class="form-control" type="text" id="datepicker2">
								</div>
			  			</div>
	      		</div>
	  
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
						<input type="submit" data-dismiss="modal"  style="display: none" name="Incluir" id="id_incluir" Value="Incluir" class="btn btn-primary" />
		      </div>
		    </div>
		  </div>
		</div>

	{% endif %}
{% endblock detail_content %}


{% block extra_js %}
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="/resources/demos/style.css">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script language="Javascript">

		//##############################################################
		//                Inicialização da View                        #
		//##############################################################

	  // Se a composicao estiver completa, deve-se esconder o botão e os
	  // campos de inserção
	  $(document).ready(function(){
    	if($("#id_parlamentar").val() == null || $("#id_cargo").val() == null){
    		$("#id_parlamentar").hide();
    		$("#id_cargo").hide();
    		$("#parlamentar-cargo-title").hide();
    		$('#id_incluir').hide();
    	}
    	else{
    		$("#id_parlamentar").show();
    		$("#id_cargo").show();
    		$("#parlamentar-cargo-title").show();
    		$('#id_incluir').show();
    	}

    	// Se a composição estiver vazia, deve-se esconder
    	// de Excluir
    	if (!$("#id_composicao_mesa option").val()){
    		$("#id_excluir").hide()
    	}
    	else{
    		$("#id_excluir").show()
    	}
    });

	 $( "#datepicker" ).datepicker();
	 $( "#datepicker2" ).datepicker();
	 $( "#datepicker" ).datepicker( "option", "dateFormat", "dd/mm/yy");
	 $( "#datepicker2" ).datepicker( "option", "dateFormat", "dd/mm/yy");
	 $( "#datepicker" ).val("01/01/{{sessao_selecionada.data_inicio.year}}");
	 $( "#datepicker2" ).val("31/12/{{sessao_selecionada.data_inicio.year}}");

	 validate_date = () => {
		 s_date = ($("#datepicker").val()).split('/')
		 s_date2 = ($("#datepicker2").val()).split('/')
		 dt = new Date(day=s_date[2],month=(s_date[1]-1),year=s_date[0])
		 dt2 = new Date(day=s_date2[2],month=(s_date2[1]-1),year=s_date2[0])
	
		 if (dt > dt2){
			alert("Data Inicial deve ser menor que a final.")
		 }
	 }

	 $("#datepicker").change(validate_date)


	
    //##############################################################
    //#                     EVENT HANDLERS                         #
    //##############################################################

    function errors_handler(msg){
    
      $("#div-success").hide()
      $("#div-error").hide()
      $("#success-message").html('')
      $("#error-message").html('')
      	  
  	  if (msg != null){
  	  	if (msg[1] == 0){
  	  		$("#div-error").show()
  	  		$("#error-message").html(msg[0])
  	  	}
  	  	else{
  	  		$("#div-success").show()
  	  		$("#success-message").html(msg[0])
  	  	}
  	  }

    }

	  // Atualiza os campos após alguma operação de mudança da Legislatura/Sessao ou
	  // Inserção/Remoção
    function altera_field(id_legislatura, id_sessao=null, msg=null){
      // Pega o novo valor dos campos modificados
      var sessao_value = id_sessao
      var legislatura_value = id_legislatura

      // Limpa os campos que serão atualizados
      $("#id_sessao_legislativa option").remove();
      $("#id_composicao_mesa tbody tr").remove();
      $("#id_parlamentar option").remove();
      $("#id_cargo option").remove();


      $.get("{% url 'sapl.parlamentares:altera_field_mesa' %}",
      	{legislatura: legislatura_value, sessao: sessao_value},
      	function(data) {
      		// Caso não venha nenhum dado da requisição, retorna null
      	  if ($.isEmptyObject(data)){
      	  	return null
      	  }

          lista_sessoes = data['lista_sessoes'];
          lista_composicao = data['lista_composicao'];
          lista_parlamentares = data['lista_parlamentares'];
          lista_cargos = data['lista_cargos'];

          // Atualiza a listagem dos campos
          for (i = 0; i < lista_sessoes.length; i++) {
              $('#id_sessao_legislativa').append('<option value="' + lista_sessoes[i][0] + '">' + lista_sessoes[i][1] + '</option>');
          }

          for (i = 0; i < lista_composicao.length; i++) {
              $('#id_composicao_mesa').append('<tr value="' + lista_composicao[i][0] + '">' +
																							 '<td>' + lista_composicao[i][1] + ' </td> ' +
																							  '<td>' + lista_composicao[i][2] + '</td>' +
																								'<td>' + lista_composicao[i][3] + '</td>' +
																								'<td>' + lista_composicao[i][4] + '</td>' +
																								'<td><button id="'+ lista_composicao[i][0] +'" onclick="apaga_membro_mesa(this)" type="button" class="btn btn-danger">Apagar</button></td>' +
																								 + '</tr>');
          }

          // Caso ainda tenha parlamentares/cargos a serem inseridos, preenche a listagem com
          // os disponíveis e garante que as ferramentas de inserção estejam disponíveis
          if (lista_parlamentares.length != 0 && lista_cargos.length != 0){
          	$('#id_incluir').show()
          	$('#id_cargo').show();
	      		$('#id_parlamentar').show();
	      		$("#parlamentar-cargo-title").show();

	          for (i = 0; i < lista_parlamentares.length; i++) {
	              $('#id_parlamentar').append('<option value="' + lista_parlamentares[i][0] + '">' + lista_parlamentares[i][1] + '</option>');
	          }

	          for (i = 0; i < lista_cargos.length; i++) {
	              $('#id_cargo').append('<option value="' + lista_cargos[i][0] + '">' + lista_cargos[i][1] + '</option>');
	          }
	      	}

	      	// Caso contrário, esconde do usuário essas opções
	      	else{
	      		$('#id_incluir').hide();
	      		$('#id_cargo').hide();
	      		$('#id_parlamentar').hide();
	      		$("#parlamentar-cargo-title").hide();
	      	}

	      	// Garante que o botão de remoção aparecerá, caso tenha
	      	// algum parlamentar na composição
	      	if (lista_composicao.length != 0){
    				$("#id_excluir").show()
    			}
    			else{
    				$("#id_excluir").hide()
    			}

	      // Garante que a Sessão atual será a selecionada previamente e, no caso em que
	      // o campo modificado seja o de Legislatura, que a Sessão seja a última daquela
	      // legislatura
	      $("#id_sessao_legislativa").val(data['sessao_selecionada'])

	      // Caso haja algum erro que venha após a alteração da legislatura/sessao
	      // Essa mensagem de erro é prioridade
	      if (data['msg'][1] == 0){
	      	msg = data['msg']
		  }
				errors_handler(msg)
		  
		  index_sessao = document.getElementById("id_sessao_legislativa").selectedIndex;
		  $("#datepicker").val("01/01/" + lista_sessoes[index_sessao][2]);
	 	  $("#datepicker2").val("31/12/" + lista_sessoes[index_sessao][2]);
			
      });

    }

    //#############################################################
    //#                     EVENTS CATCH                          #
    //#############################################################
    $("#id_legislatura").change(function(){
    	legislatura = $("#id_legislatura").val();
    	altera_field(legislatura);
    });

    $("#id_sessao_legislativa").change(function(){
    	legislatura = $("#id_legislatura").val();
    	sessao = $("#id_sessao_legislativa").val();
    	altera_field(legislatura, sessao);
    });

    $('#id_incluir').click(function(){
    	$.ajax({
	        data: {sessao: $("#id_sessao_legislativa").val(),
	               parlamentar: $("#id_parlamentar").val(),
	               cargo: $("#id_cargo").val(),
				   data_inicial: $("#datepicker").val(),
				   data_fim: $("#datepicker2").val()},
	        type: 'POST',
	        url: "{% url 'sapl.parlamentares:insere_parlamentar_composicao' %}",
	        headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
          success: function(data){
          						var msg = data['msg'];
          						legislatura = $("#id_legislatura").val();
    									sessao = $("#id_sessao_legislativa").val();
				              setTimeout(function(data){
				               // Atualiza os campos após a inserção
				            	 altera_field(legislatura, sessao, msg)
				             }, 500)
                   },
	    });
		})

    function apaga_membro_mesa(selecionado){
    	// Pega o id do parlamentar que foi selecionado
    	if (selecionado){
	    	$.ajax({
		        data: {composicao_mesa: selecionado.id},
		        type: 'POST',
		        url: "{% url 'sapl.parlamentares:remove_parlamentar_composicao' %}",
		        headers: {
	                'X-CSRFToken': getCookie('csrftoken')
	            },
	          success: function(data){
	                      var msg = data['msg'];
	                      legislatura = $("#id_legislatura").val();
    										sessao = $("#id_sessao_legislativa").val();

					              setTimeout(function(data){
					               // Atualiza os campos após a remoção
					            	 altera_field(legislatura, sessao, msg)
					             }, 500)
	                   },
		    });
    	}
    }

</script>

{% endblock %}

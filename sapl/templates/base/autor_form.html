{% extends "crud/form.html" %}
{% load i18n %}
{% block extra_js %}

<script type="text/javascript">

$(document).ready(function(){
  var active = function(str) {
    if (str == 'nome') {
      $('#id_nome, #id_q').val('');
      $('#div_id_nome').removeClass('hidden');
      $("[data-application='AutorSearch']").addClass('hidden');
      $("#div_id_autor_related .controls").html('');
    }
    else {
      $('#id_nome').val('');
      $('#div_id_nome').addClass('hidden');
      $("[data-application='AutorSearch']").removeClass('hidden');
    }
  }
  var update_search = function(pk, atualizar=true) {
    var q = $('#id_q').val();
    var url = '{% url 'sapl.api:autores_possiveis_pelo_tipo' 0 %}'
    url = url.replace('0', pk);

    var formData = {
          'q'      : q,
          'format' : 'json',
    }
    $.get(url, formData).done(function(data) {
        active('pesquisa');
        if (atualizar) {
          var radios = $("#div_id_autor_related .controls").html('');
          data.forEach(function (val, index) {
            var html_radio = '<label class="radio"><span class="icons"><span class="first-icon"></span><span class="second-icon"></span></span><input type="radio" name="autor_related" id="id_autor_related_'+index+'" value="'+val.pk+'">'+val.display+'</label>';
            radios.append(html_radio);
          });

          if (data.length > 1) {
            $('input[name=autor_related]').change(function(event){
              if (this.checked)
                $('#id_q').val(event.target.parentElement.textContent);
              //$('input[name=autor_related]:not(:checked)').closest('.radio').remove();
            });
          }
          else {
            $('input[name=autor_related]').prop('checked', 'checked');
            $('input[name=autor_related]').closest('.radio').addClass('checked');
          }
        }
        else{
          $('#id_nome, #id_q').val('');
        }
      }).fail(function(data) {
        active('nome');
      });
  }
  $('#id_tipo').change(function(event) {
    if (event.target.selectedIndex == 0) {
      $('#id_nome, #id_q').val('');
      active('nome');
    }
    else {
      var pk = this[event.target.selectedIndex].value;
      $('input[name=autor_related]').closest('.radio').remove();
      update_search(pk, false)
    }
  });
  $('.btn-filtrar-autor').click(function(event) {
    var pk = $('#id_tipo').val();
    update_search(pk);
  });
  $('input[name=action_user]').change(function(event) {
    if (event.target.value == 'C')
      $('.new_user_fields, #div_id_username').removeClass('hidden');
    else if (event.target.value == 'N')
      $('.new_user_fields, #div_id_username').addClass('hidden');
    else {
      $('#div_id_username').removeClass('hidden');
      $('.new_user_fields').addClass('hidden');
    }
  });

  $('input[name=action_user]:checked').trigger('change');
  $('input[name=autor_related]').closest('.radio').remove();

  var pk = $('#id_tipo').val();
  if (pk)
    update_search(pk, $('#id_q').val().length > 0)

});


</script>

{% endblock %}
